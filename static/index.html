<!DOCTYPE html>
<html>
<head>
    <title>Word Game</title>
    <style>
        .grid {
            display: grid;
            grid-template-columns: repeat(4, 100px);
            gap: 10px;
        }
        .cell {
            border: 1px solid black;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background-color: #f0f0f0;
        }
        .cell.selected {
            background-color: yellow;
        }
        .cell.matched {
            background-color: green;
        }
    </style>
</head>
<body>
    <div class="grid" id="game-grid"></div>
    <button onclick="loadGame()">Restart Game</button>
    <script>
        let selectedWords = [];
        let matchedPairs = new Set();

        async function loadGame() {
            try {
                const response = await fetch('/game');
                if (!response.ok) throw new Error('Failed to load game');
                const data = await response.json();
                const grid = data.grid;
                const word_ids = data.word_ids;

                const gameGrid = document.getElementById('game-grid');
                gameGrid.innerHTML = ''; // 清空网格
                selectedWords = [];
                matchedPairs.clear();

                grid.forEach(cell => {
                    const cellElement = document.createElement('div');
                    cellElement.classList.add('cell');
                    cellElement.textContent = cell.value;
                    cellElement.dataset.id = cell.id;
                    cellElement.addEventListener('click', () => handleCellClick(cell.id, word_ids, cellElement));
                    gameGrid.appendChild(cellElement);
                });

                window.wordIds = word_ids;
            } catch (error) {
                console.error('Error loading game:', error);
                alert('Failed to load game. Please check the server.');
            }
        }

        async function handleCellClick(cellId, word_ids, cellElement) {
            if (matchedPairs.has(cellId) || selectedWords.includes(cellId)) return;

            selectedWords.push(cellId);
            cellElement.classList.add('selected');

            if (selectedWords.length === 2) {
                const response = await fetch('/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        word1_id: selectedWords[0],
                        word2_id: selectedWords[1],
                        word_ids: word_ids
                    })
                });
                const data = await response.json();

                const cells = document.querySelectorAll('.cell.selected');
                if (data.result) {
                    alert('Match!');
                    cells.forEach(cell => {
                        cell.classList.remove('selected');
                        cell.classList.add('matched');
                        matchedPairs.add(parseInt(cell.dataset.id));
                    });
                } else {
                    alert('No match!');
                    cells.forEach(cell => cell.classList.remove('selected'));
                }
                selectedWords = [];
            }
        }

        // 页面加载时启动游戏
        loadGame();
    </script>
</body>
</html>