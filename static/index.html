<!DOCTYPE html>
<html>
<head>
    <title>知识消消乐</title>
    <style>
        .container { text-align: center; margin: 20px; font-family: Arial, sans-serif; }
        .mode-grid, .level-grid { display: grid; grid-template-columns: repeat(2, 120px); gap: 15px; justify-content: center; }
        .game-grid { display: grid; grid-template-columns: repeat(2, 100px); gap: 10px; margin: 20px auto; width: fit-content; }
        .card, .cell { border: 1px solid #333; padding: 15px; text-align: center; cursor: pointer; background-color: #e0e0e0; border-radius: 5px; }
        .card:hover, .cell:not(.matched):not(.wrong):hover { background-color: #d0d0d0; }
        .cell { background-color: #f0f0f0; }
        .cell.selected { background-color: #ffd700; }
        .cell.matched { background-color: #a9a9a9; cursor: default; }
        .cell.wrong { background-color: #ff4040; cursor: default; }
        button { padding: 10px 20px; margin: 5px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #45a049; }
        textarea { margin: 10px; padding: 10px; width: 300px; }
        #timer, #score { font-size: 20px; margin: 10px; }
        #scoreboard { margin-top: 20px; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border: 1px solid #333; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
    </style>
</head>
<body>
    <div id="main-menu" class="container">
        <h1>知识消消乐</h1>
        <h3>选择模式</h3>
        <div class="mode-grid">
            <div class="card" onclick="showLevels('65')">65秒</div>
            <div class="card" onclick="showLevels('125')">125秒</div>
            <div class="card" onclick="showLevels('180')">180秒</div>
            <div class="card" onclick="showLevels('endless')">无尽模式</div>
        </div>
        <button onclick="showUpload()">添加单词库</button>
        <div id="scoreboard">
            <h3>排行榜</h3>
            <ul id="score-list"></ul>
        </div>
    </div>

    <div id="level-menu" class="container" style="display: none;">
        <h2>选择难度</h2>
        <div class="level-grid">
            <div class="card" onclick="startGame('lv1')">Lv1</div>
            <div class="card" onclick="startGame('lv2')">Lv2</div>
            <div class="card" onclick="startGame('lv3')">Lv3</div>
            <div class="card" onclick="startGame('lv4')">Lv4</div>
            <div class="card" onclick="startGame('lv5')">Lv5</div>
            <div class="card" onclick="startGame('lv6')">Lv6</div>
        </div>
        <button onclick="showMainMenu()">返回</button>
    </div>

    <div id="game" class="container" style="display: none;">
        <div id="timer">时间: --</div>
        <div id="score">分数: 0</div>
        <div id="group-info">第 1 组</div>
        <div id="game-grid" class="game-grid"></div>
        <button onclick="endGame()">结束游戏</button>
        <button onclick="showLevels(currentTimeMode)">返回</button>
        <button onclick="showMainMenu()">回到主页</button>
    </div>

    <div id="upload" class="container" style="display: none;">
        <h2>添加单词库</h2>
        <textarea id="word-text" rows="5" cols="30" placeholder="english,chinese,difficulty
apple,苹果,L1"></textarea><br>
        <input type="file" id="word-file" accept=".csv"><br>
        <button onclick="uploadWords()">上传</button>
        <button onclick="showMainMenu()">返回</button>
    </div>

    <div id="end-modal" class="modal">
        <h2>游戏结束</h2>
        <p id="final-score"></p>
        <button onclick="closeModal()">关闭</button>
        <button onclick="showMainMenu()">回到主页</button>
        <button onclick="nextLevel()">下一关</button>
    </div>

    <script>
        let selectedWords = [];
        let matchedPairs = new Set();
        let wrongPairs = new Set();
        let currentLevel = 'lv1';
        let currentTimeMode = '65';
        let groups = [];
        let currentGroup = 0;
        let score = 0;
        let timerId = null;
        let timeElapsed = 0;
        let rows = 4;

        function showMainMenu() {
            stopTimer();
            document.getElementById('main-menu').style.display = 'block';
            document.getElementById('level-menu').style.display = 'none';
            document.getElementById('game').style.display = 'none';
            document.getElementById('upload').style.display = 'none';
            document.getElementById('end-modal').style.display = 'none';
            loadScores();
        }

        function showLevels(timeMode) {
            currentTimeMode = timeMode;
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('level-menu').style.display = 'block';
            document.getElementById('game').style.display = 'none';
            document.getElementById('upload').style.display = 'none';
        }

        function showUpload() {
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('level-menu').style.display = 'none';
            document.getElementById('game').style.display = 'none';
            document.getElementById('upload').style.display = 'block';
        }

        async function startGame(level) {
            currentLevel = level;
            score = 0;
            currentGroup = 0;
            timeElapsed = 0;
            try {
                const response = await fetch(`/game/${level}`);
                if (!response.ok) throw new Error('Failed to load game');
                const data = await response.json();
                groups = data.groups;
                rows = data.rows;

                document.getElementById('main-menu').style.display = 'none';
                document.getElementById('level-menu').style.display = 'none';
                document.getElementById('game').style.display = 'block';
                document.getElementById('upload').style.display = 'none';

                loadGroup();
                startTimer();
            } catch (error) {
                console.error('Error loading game:', error);
                alert('Failed to load game.');
            }
        }

        function loadGroup() {
            if (currentTimeMode !== 'endless' && currentGroup >= 6) {
                endGame();
                return;
            }
            if (currentGroup >= groups.length && currentTimeMode === 'endless') {
                fetchNextGroup();
                return;
            }
            const { grid, word_ids } = groups[currentGroup];
            const gameGrid = document.getElementById('game-grid');
            gameGrid.innerHTML = '';
            selectedWords = [];
            matchedPairs.clear();
            wrongPairs.clear();
            document.getElementById('group-info').textContent = `第 ${currentGroup + 1} 组`;
            document.getElementById('score').textContent = `分数: ${score}`;

            grid.forEach(cell => {
                const cellElement = document.createElement('div');
                cellElement.classList.add('cell');
                cellElement.textContent = cell.value;
                cellElement.dataset.id = cell.id;
                cellElement.addEventListener('click', () => handleCellClick(cell.id, word_ids, cellElement));
                gameGrid.appendChild(cellElement);
            });
            window.wordIds = word_ids;
        }

        async function handleCellClick(cellId, word_ids, cellElement) {
            if (matchedPairs.has(cellId) || wrongPairs.has(cellId) || selectedWords.includes(cellId)) return;

            selectedWords.push(cellId);
            cellElement.classList.add('selected');

            if (selectedWords.length === 2) {
                const response = await fetch('/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        word1_id: selectedWords[0],
                        word2_id: selectedWords[1],
                        word_ids: word_ids
                    })
                });
                const data = await response.json();

                const cells = document.querySelectorAll('.cell.selected');
                if (data.result) {
                    score += 1;
                    document.getElementById('score').textContent = `分数: ${score}`;
                    cells.forEach(cell => {
                        cell.classList.remove('selected');
                        cell.classList.add('matched');
                        matchedPairs.add(parseInt(cell.dataset.id));
                    });
                    if (matchedPairs.size === rows * 2) {
                        currentGroup += 1;
                        setTimeout(loadGroup, 500); // 自动下一页，延迟0.5秒
                    }
                } else {
                    cells.forEach(cell => {
                        cell.classList.remove('selected');
                        cell.classList.add('wrong');
                        wrongPairs.add(parseInt(cell.dataset.id));
                    });
                }
                selectedWords = [];
            }
        }

        async function fetchNextGroup() {
            const response = await fetch(`/next_group/${currentLevel}`);
            const data = await response.json();
            groups.push({ grid: data.grid, word_ids: data.word_ids });
            loadGroup();
        }

        function startTimer() {
            stopTimer();
            timeElapsed = 0;
            document.getElementById('timer').textContent = `时间: ${timeElapsed}秒`;
            timerId = setInterval(() => {
                timeElapsed += 1;
                document.getElementById('timer').textContent = `时间: ${timeElapsed}秒`;
                if (currentTimeMode !== 'endless' && timeElapsed >= parseInt(currentTimeMode)) {
                    endGame();
                }
            }, 1000);
        }

        function stopTimer() {
            if (timerId) {
                clearInterval(timerId);
                timerId = null;
            }
        }

        async function endGame() {
            stopTimer();
            await fetch('/save_score', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ time_mode: currentTimeMode, level: currentLevel, score: score })
            });
            document.getElementById('final-score').textContent = `你的分数: ${score}`;
            document.getElementById('end-modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('end-modal').style.display = 'none';
        }

        function nextLevel() {
            const levels = ['lv1', 'lv2', 'lv3', 'lv4', 'lv5', 'lv6'];
            const nextIdx = levels.indexOf(currentLevel) + 1;
            if (nextIdx < levels.length) {
                startGame(levels[nextIdx]);
                document.getElementById('end-modal').style.display = 'none';
            } else {
                alert('已经是最后一关！');
                showMainMenu();
            }
        }

        async function loadScores() {
            const response = await fetch('/get_scores');
            const scores = await response.json();
            const scoreList = document.getElementById('score-list');
            scoreList.innerHTML = '';
            scores.forEach(s => {
                const li = document.createElement('li');
                li.textContent = `难度${s.level.toUpperCase()} ${s.time_mode === 'endless' ? '无尽' : s.time_mode + '秒'} ${s.score}分`;
                scoreList.appendChild(li);
            });
        }

        async function uploadWords() {
            const text = document.getElementById('word-text').value;
            const file = document.getElementById('word-file').files[0];
            const formData = new FormData();
            if (file) formData.append('file', file);
            else if (text) formData.append('text', text);
            else {
                alert('请提供文本或文件');
                return;
            }
            const response = await fetch('/upload_words', { method: 'POST', body: formData });
            const data = await response.json();
            alert(data.message || data.error);
            if (response.ok) showMainMenu();
        }

        showMainMenu();
    </script>
</body>
</html>