<!DOCTYPE html>
    <html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Word Game</title>
        <style>
            body {
                font-family: sans-serif;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100vh;
                margin: 0;
            }

            .game-container {
                display: none;
                flex-direction: column;
                align-items: center;
            }

            .grid {
                display: grid;
                gap: 5px;
                margin-bottom: 20px;
            }

            .card {
                width: 80px;
                height: 80px;
                border: 1px solid #ccc;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            }

            .level-select {
                display: flex;
                gap: 10px;
            }

            .level-select button {
                padding: 10px 20px;
                cursor: pointer;
            }

            #time-display {
                margin-bottom: 10px;
            }

            #score-display {
                margin-bottom: 10px;
            }

            #upload-form {
                margin-top: 20px;
            }

            #upload-form input[type="file"] {
                margin-bottom: 10px;
            }
        </style>
    </head>

    <body>
        <h1>Word Game</h1>

        <div class="level-select">
            <button onclick="showLevels('65')">65秒</button>
            <button onclick="showLevels('120')">120秒</button>
            <button onclick="showLevels('endless')">无尽模式</button>
        </div>

        <div id="time-mode-select" style="display: none;">
            <button onclick="startGame('lv1')">Lv1</button>
            <button onclick="startGame('lv2')">Lv2</button>
            <button onclick="startGame('lv3')">Lv3</button>
            <button onclick="startGame('lv4')">Lv4</button>
            <button onclick="startGame('lv5')">Lv5</button>
            <button onclick="startGame('lv6')">Lv6</button>
        </div>

        <div class="game-container" id="game-container">
            <div id="time-display"></div>
            <div id="score-display"></div>
            <div class="grid" id="grid"></div>
            <button onclick="nextGroup()" id="next-group-button" style="display: none;">下一组</button>
        </div>

        <form id="upload-form" enctype="multipart/form-data">
            <input type="file" name="file" id="file-upload">
            <button type="button" onclick="uploadWords()">上传单词本</button>
        </form>

        <script>
            let wordIds = {};
            let selectedCards = [];
            let score = 0;
            let timeLeft = 0;
            let timer;
            let currentLevel = '';
            let currentGroupIndex = 0;
            let gameData = null;

            function showLevels(timeMode) {
                if (timeMode !== 'endless') {
                    timeLeft = parseInt(timeMode);
                } else {
                    timeLeft = 0;
                }
                document.getElementById('time-mode-select').style.display = 'flex';
                document.querySelector('.level-select').style.display = 'none';
            }

            async function startGame(level) {
                currentLevel = level;
                currentGroupIndex = 0;
                score = 0;
                document.getElementById('score-display').textContent = `得分: ${score}`;
                document.getElementById('time-mode-select').style.display = 'none';
                document.getElementById('game-container').style.display = 'flex';
                await loadGameData();
                loadGroup();
                if (timeLeft > 0) {
                    startTimer();
                } else {
                    document.getElementById('time-display').textContent = '无尽模式';
                }
            }

            async function loadGameData() {
                const response = await fetch(`/game/${currentLevel}`);
                gameData = await response.json();
            }

            function loadGroup() {
                const group = gameData.groups[currentGroupIndex];
                const grid = document.getElementById('grid');
                grid.innerHTML = '';
                grid.style.gridTemplateColumns = `repeat(${Math.sqrt(group.grid.length)}, 1fr)`;
                group.grid.forEach(item => {
                    const card = document.createElement('div');
                    card.classList.add('card');
                    card.textContent = item.value;
                    card.dataset.id = item.id;
                    card.onclick = () => selectCard(item.id);
                    grid.appendChild(card);
                });
                wordIds = group.word_ids;
                if (currentLevel !== 'endless' && currentGroupIndex < gameData.groups.length - 1) {
                    document.getElementById('next-group-button').style.display = 'block';
                } else {
                    document.getElementById('next-group-button').style.display = 'none';
                }
            }

            function selectCard(id) {
                if (selectedCards.length < 2 && !selectedCards.includes(id)) {
                    selectedCards.push(id);
                    if (selectedCards.length === 2) {
                        checkMatch();
                    }
                }
            }

            async function checkMatch() {
                const response = await fetch('/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        word1_id: selectedCards[0],
                        word2_id: selectedCards[1],
                        word_ids: wordIds
                    })
                });
                const data = await response.json();
                if (data.result) {
                    score += 10;
                    document.getElementById('score-display').textContent = `得分: ${score}`;
                    selectedCards.forEach(id => {
                        document.querySelector(`.card[data-id="${id}"]`).style.visibility = 'hidden';
                    });
                }
                selectedCards = [];
            }

            function startTimer() {
                document.getElementById('time-display').textContent = `剩余时间: ${timeLeft}秒`;
                timer = setInterval(() => {
                    timeLeft--;
                    document.getElementById('time-display').textContent = `剩余时间: ${timeLeft}秒`;
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        endGame();
                    }
                }, 1000);
            }

            function endGame() {
                alert(`游戏结束，您的得分是: ${score}`);
                document.getElementById('game-container').style.display = 'none';
                document.querySelector('.level-select').style.display = 'flex';
                saveScore(score);
            }

            async function nextGroup() {
                currentGroupIndex++;
                if (currentGroupIndex < gameData.groups.length) {
                    loadGroup();
                } else {
                    endGame();
                }
            }

            async function uploadWords() {
                const fileInput = document.getElementById('file-upload');
                const file = fileInput.files[0];
                if (!file) {
                    alert('请选择一个文件');
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/upload_words', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                alert(data.message || data.error || '上传成功');
            }

            async function saveScore(score) {
                await fetch('/save_score', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        score: score,
                        level: currentLevel,
                        time: new Date().toISOString()
                    })
                });
            }
        </script>
    </body>

    </html>